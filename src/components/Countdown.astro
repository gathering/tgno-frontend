---
interface Props {
  targetDate: string; // ISO 8601
  confetti?: boolean;
  endMessage?: string;
}
const {
  targetDate,
  confetti = false,
  endMessage = "Countdown complete",
} = Astro.props;
---

<div
  id="countdown"
  class="flex flex-wrap items-center justify-center gap-x-3 gap-y-1 sm:gap-x-4 rounded-xl text-white whitespace-nowrap leading-none"
  data-target={targetDate}
  data-confetti={confetti ? "true" : "false"}
  data-end-message={endMessage}
>
  <div class="text-center">
    <div
      class="text-lg sm:text-2xl md:text-3xl font-bold tabular-nums"
      data-days
    >
      0
    </div>
    <div class="text-xs uppercase tracking-wide text-neutral-400">Days</div>
  </div>

  <div class="text-center">
    <div
      class="text-lg sm:text-2xl md:text-3xl font-bold tabular-nums"
      data-hours
    >
      0
    </div>
    <div class="text-xs uppercase tracking-wide text-neutral-400">Hours</div>
  </div>

  <div class="text-center">
    <div
      class="text-lg sm:text-2xl md:text-3xl font-bold tabular-nums"
      data-minutes
    >
      0
    </div>
    <div class="text-xs uppercase tracking-wide text-neutral-400">Minutes</div>
  </div>

  <div class="text-center">
    <div
      class="text-lg sm:text-2xl md:text-3xl font-bold tabular-nums"
      data-seconds
    >
      0
    </div>
    <div class="text-xs uppercase tracking-wide text-neutral-400">Seconds</div>
  </div>
</div>

<script lang="ts">
  const container = document.getElementById("countdown");
  if (!(container instanceof HTMLDivElement))
    throw new Error("Countdown not found");

  const targetAttr = container.dataset.target;
  if (!targetAttr) throw new Error("Missing target date");

  const targetTime = new Date(targetAttr).getTime();
  if (Number.isNaN(targetTime)) throw new Error("Invalid target date");

  const confettiEnabled = container.dataset.confetti === "true";
  const endMessage = container.dataset.endMessage || "Countdown complete";

  const daysEl = container.querySelector("[data-days]");
  const hoursEl = container.querySelector("[data-hours]");
  const minutesEl = container.querySelector("[data-minutes]");
  const secondsEl = container.querySelector("[data-seconds]");

  if (!(daysEl && hoursEl && minutesEl && secondsEl))
    throw new Error("Parts not found");

  function render(diff) {
    daysEl.textContent = String(Math.floor(diff / 86_400_000));
    hoursEl.textContent = String(Math.floor((diff / 3_600_000) % 24));
    minutesEl.textContent = String(Math.floor((diff / 60_000) % 60));
    secondsEl.textContent = String(Math.floor((diff / 1_000) % 60));
  }

  function loadConfetti() {
    return new Promise((resolve, reject) => {
      if (window.confetti) return resolve(window.confetti);

      const s = document.createElement("script");
      s.src =
        "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js";
      s.onload = () => resolve(window.confetti);
      s.onerror = () => reject(new Error("Failed to load confetti"));
      document.head.appendChild(s);
    });
  }

  async function playConfetti() {
    const confetti = await loadConfetti();
    confetti({
      particleCount: 80,
      angle: 60,
      spread: 70,
      origin: { x: 0, y: 0.7 },
    });
    confetti({
      particleCount: 80,
      angle: 120,
      spread: 70,
      origin: { x: 1, y: 0.7 },
    });
  }

  let timer;
  let launched = false;

  function launch() {
    if (launched) return;
    launched = true;

    if (timer) window.clearInterval(timer);
    container.innerHTML = `<span class="text-2xl font-semibold bg-gradient-to-r from-[#12abcf] to-[#e6693b] bg-clip-text text-transparent">${endMessage}</span>`;

    if (confettiEnabled) void playConfetti();
  }

  function update() {
    const diff = targetTime - Date.now();
    if (diff <= 0) return launch();
    render(diff);
  }

  update();
  timer = window.setInterval(update, 1000);
</script>

---
import ArrowSymbol from "../icons/ArrowSymbol.astro";

interface Props {
  startExpanded?: boolean;
  toggleVariant?: "header" | "footer";
  class?: string;
}

const {
  startExpanded = false,
  toggleVariant = "header" as "header" | "footer",
  class: className = "",
} = Astro.props;
---

<script>
  class Collapsible extends HTMLElement {
    connectedCallback() {
      let open = this.dataset.startExpanded === "true";

      const content = this.querySelector("[data-part=collapsible]");
      if (!(content instanceof HTMLElement)) return;

      const triggers = Array.from(
        this.querySelectorAll(
          "[data-part=collapsible-trigger], .collapsible-click-area",
        ),
      ).filter((el) => el instanceof HTMLElement);

      const setOpen = (value: boolean) => {
        open = value;

        content.classList.toggle("hidden", !open);

        triggers.forEach((el) => {
          el.setAttribute("aria-expanded", String(open));

          const icon = el.querySelector("svg");
          if (icon instanceof SVGElement) {
            icon.classList.toggle("rotate-180", open);
          }
        });
      };

      const toggle = () => setOpen(!open);

      triggers.forEach((el) => {
        el.addEventListener("click", toggle);
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggle();
          }
        });
      });

      setOpen(open);
    }
  }

  if (!customElements.get("tg-collapsible")) {
    customElements.define("tg-collapsible", Collapsible);
  }
</script>

<tg-collapsible data-start-expanded={startExpanded} class={className}>
  {
    toggleVariant === "header" && (
      <div
        class="flex justify-between items-center collapsible-click-area cursor-pointer"
        role="button"
        tabindex="0"
        aria-expanded={startExpanded}
      >
        <slot name="header" />
        <ArrowSymbol class="transition-transform duration-300 text-white" />
      </div>
    )
  }

  <section
    id="collapsible-content"
    data-part="collapsible"
    class={`${startExpanded ? "" : "hidden"}`}
  >
    <slot />
  </section>

  {
    toggleVariant === "footer" && (
      <div class="flex justify-between items-center collapsible-click-area">
        <slot name="footer" />
        <button
          data-part="collapsible-trigger"
          aria-expanded={startExpanded}
          class="flex items-center justify-center"
        >
          Les mer
        </button>
      </div>
    )
  }
</tg-collapsible>

---
import ArrowSymbol from "../icons/ArrowSymbol.astro";

interface Props {
  startExpanded?: boolean;
  toggleVariant?: "header" | "footer";
  class?: string;
}

const {
  startExpanded = false,
  toggleVariant = "header" as "header" | "footer",
  class: className = "",
} = Astro.props;

// Generate unique IDs
const contentId = `collapsible-content-${Math.random().toString(36).slice(2)}`;
const triggerId = `collapsible-trigger-${Math.random().toString(36).slice(2)}`;
---

<script>
  class Collapsible extends HTMLElement {
    connectedCallback() {
      let open = this.dataset.startExpanded === "true";

      const content = this.querySelector("[data-part=collapsible]");
      if (!(content instanceof HTMLElement)) return;

      const triggers = Array.from(
        this.querySelectorAll(
          ".collapsible-click-area, [data-part=collapsible-trigger]",
        ),
      ).filter((el) => el instanceof HTMLElement);

      const setOpen = (value: boolean) => {
        open = value;

        // Show/hide content
        content.classList.toggle("hidden", !open);

        // Update triggers
        triggers.forEach((el) => {
          el.setAttribute("aria-expanded", String(open));

          // Rotate arrow
          const icon = el.querySelector("svg");
          if (icon instanceof SVGElement) {
            icon.classList.toggle("rotate-180", open);
          }
        });
      };

      const toggle = () => setOpen(!open);

      // Attach event listeners to triggers (also handles keyboard events for accessibility)
      triggers.forEach((el) => {
        el.addEventListener("click", toggle);
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggle();
          }
        });
      });

      setOpen(open);
    }
  }

  if (!customElements.get("tg-collapsible")) {
    customElements.define("tg-collapsible", Collapsible);
  }
</script>

<tg-collapsible data-start-expanded={startExpanded} class={className}>
  {
    toggleVariant === "header" && (
      <div
        id={triggerId}
        class="flex justify-between items-center collapsible-click-area cursor-pointer"
        role="button"
        tabindex="0"
        aria-expanded={startExpanded}
        aria-controls={contentId}
      >
        <slot name="header" />
        <ArrowSymbol class="transition-transform duration-300 text-white" />
      </div>
    )
  }

  <section
    id={contentId}
    data-part="collapsible"
    role="region"
    aria-labelledby={triggerId}
    class={`${startExpanded ? "" : "hidden"}`}
  >
    <slot />
  </section>

  {
    toggleVariant === "footer" && (
      <div
        class="flex justify-between items-center collapsible-click-area cursor-pointer"
        role="button"
        tabindex="0"
        aria-expanded={startExpanded}
        aria-controls={contentId}
      >
        <slot name="footer" />
        <span class="flex items-center justify-center">Les mer</span>
      </div>
    )
  }
</tg-collapsible>

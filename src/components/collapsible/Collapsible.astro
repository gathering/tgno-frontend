---
import ArrowSymbol from "../icons/ArrowSymbol.astro";

interface Props {
  startExpanded?: boolean;
  toggleVariant?: "header" | "footer";
  class?: string;
}

const {
  startExpanded = false,
  toggleVariant = "header" as "header" | "footer",
  class: className = "",
} = Astro.props;
---

<script>
  class Collapsible extends HTMLElement {
    open: boolean = false;
    triggers: HTMLElement[] = [];
    content: HTMLElement | null = null;

    setOpen(next: boolean) {
      if (this.open === next) return;
      this.open = next;

      // Rotate icons if present
      this.triggers.forEach((trigger) => {
        const icon = trigger.querySelector("svg");
        if (icon instanceof SVGElement) {
          icon.classList.toggle("rotate-180", this.open);
        }
      });

      // Show/hide content
      this.content?.classList.toggle("hidden", !this.open);

      // ARIA update
      this.triggers.forEach((trigger) => {
        trigger.setAttribute("aria-expanded", String(this.open));
      });
    }

    toggle = () => this.setOpen(!this.open);

    connectedCallback() {
      this.open = this.getAttribute("data-start-expanded") === "true";

      this.triggers = Array.from(
        this.querySelectorAll<HTMLElement>("[data-part=collapsible-trigger]"),
      );

      this.content = this.querySelector<HTMLElement>("[data-part=collapsible]");
      if (!this.content) return;

      // Make entire trigger area clickable
      this.triggers.forEach((trigger) => {
        trigger.addEventListener("click", this.toggle);
        trigger.style.cursor = "pointer";
      });

      // Optional: allow clicking header/footer container itself
      const containers = this.querySelectorAll<HTMLElement>(
        ".collapsible-click-area",
      );
      containers.forEach((container) => {
        container.addEventListener("click", this.toggle);
      });

      this.setOpen(this.open);
    }
  }

  if (!customElements.get("tg-collapsible")) {
    customElements.define("tg-collapsible", Collapsible);
  }
</script>

<tg-collapsible data-start-expanded={startExpanded} class={className}>
  {
    toggleVariant === "header" && (
      <div class="flex justify-between items-center collapsible-click-area cursor-pointer">
        <slot name="header" />
        <button
          data-part="collapsible-trigger"
          aria-expanded={startExpanded}
          class="flex items-center justify-center text-white p-2 rounded-md hover:bg-gray-900 transition"
        >
          <ArrowSymbol class="transition-transform duration-300" />
        </button>
      </div>
    )
  }

  <section data-part="collapsible" class={`${startExpanded ? "" : "hidden"}`}>
    <slot />
  </section>

  {
    toggleVariant === "footer" && (
      <div class="flex justify-between items-center collapsible-click-area">
        <slot name="footer" />
        <button
          data-part="collapsible-trigger"
          aria-expanded={startExpanded}
          class="flex items-center justify-center"
        >
          Les mer
        </button>
      </div>
    )
  }
</tg-collapsible>

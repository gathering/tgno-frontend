---
import "leaflet/dist/leaflet.css";
import {
  calculateRow,
  calculateColumn,
  getStandSize,
  stringToSize,
  rotateCords,
  getStandPolygon,
  slugifyMapItemName,
} from "../../utils/map";
import TgMap from "../../components/map/TgMap.astro";
import type { MapItem, PartialMapItem } from "../../types";
import Layout from "../../layouts/Layout.astro";
import TgMapNavItem from "../../components/map/TgMapNavItem.astro";
import H3 from "../../components/H3.astro";

type MapItemBase = Pick<PartialMapItem, "icon" | "name"> &
  Partial<Omit<PartialMapItem, "icon" | "name">>;

type LocationMap = Record<string, MapItemBase>;

const STANDS: LocationMap = {
  kia: {
    icon: "/tg25/sponsors/kia_white.svg",
    name: "Kia",
    presentation: {
      type: "stand",
    },
  },
  kandu: {
    icon: "/tg25/sponsors/kandu.svg",
    name: "KANDU",
    presentation: {
      type: "stand",
    },
  },
  nexthop: {
    icon: "/tg25/sponsors/nexthop.svg",
    name: "NextHop",
    presentation: {
      type: "stand",
    },
  },
  riot: {
    icon: "/tg25/sponsors/riot_white.svg",
    name: "Riot Games",
    presentation: {
      type: "stand",
    },
  },
  nlogic: {
    icon: "/tg25/sponsors/nlogic.svg",
    name: "nLogic",
    presentation: {
      type: "stand",
    },
  },
  telenor: {
    icon: "/tg25/sponsors/telenor.svg",
    name: "Telenor",
    presentation: {
      type: "stand",
    },
  },
  placeholder: {
    icon: "/tg25/sponsors/kandu.svg",
    name: "Placeholder",
    presentation: {
      type: "stand",
    },
  },
};

const FOOD: LocationMap = {
  lorem: {
    icon: "/tg25/food/lorem.svg",
    name: "Lorem",
    presentation: {
      type: "unknown",
      interactive: false,
    },
  },
};

const ATTRACTIONS: LocationMap = {
  streamerLounge: {
    icon: "/tg25/sponsors/kandu.svg",
    name: "Placeholder",
    slug: "placeholder",
    presentation: {
      type: "stand",
    },
  },
  streamers: {
    icon: "/tg25/sponsors/kandu.svg",
    name: "Placeholder",
    slug: "streamers",
    presentation: {
      type: "stand",
    },
  },
};

const STAGES: LocationMap = {
  mainStage: {
    icon: "https://www.tg.no/tg25/tg25_square_white.svg",
    name: "Hovedscenen",
    slug: "hovedscenen",
    presentation: {
      type: "stage",
      calendarQuery: ["hovedscenen"],
      padding: 40,
    },
  },
  eSportStage: {
    icon: "https://www.tg.no/tg25/tg25_square_white.svg",
    name: "Esportscenen",
    slug: "esportscenen",
    presentation: {
      type: "stage",
      calendarQuery: ["esportscenen"],
      padding: 40,
    },
  },
  creativiaStage: {
    icon: "https://www.tg.no/tg25/tg25_square_white.svg",
    name: "Kreativiascenen",
    slug: "kreativiascenen",
    presentation: {
      type: "stage",
      calendarQuery: ["kreativiascenen"],
      padding: 40,
    },
  },
};

const SIZES = {
  small: getStandSize("3x3"),
  medium: getStandSize("6x6"),
  long: getStandSize("6x3"),
  longVertical: getStandSize("3x6"),
  superlongVertical: getStandSize("3x9"),
};

const LOCATIONS: MapItem[] = [
  // Expo outer curve
  ...[
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 268, y: 1298 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 270, y: 1398 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 294.5, y: 1499 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 340.5, y: 1591.5 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 405, y: 1674 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 485, y: 1742 },
    },
  ].map((item, index) => {
    const polygon = getStandPolygon("3x6");

    return {
      ...item,
      polygon: rotateCords(polygon[0], polygon, 12 * index),
    };
  }),

  // Top left expo cluster
  ...calculateRow([
    {
      ...STANDS.placeholder,
      ...SIZES.small,
      pos: { x: 576.3, y: 1644.3 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.small,
    },
    {
      ...STANDS.placeholder,
      ...SIZES.small,
    },
  ]),
  ...calculateRow([
    {
      ...STANDS.placeholder,
      ...SIZES.small,
      pos: { x: 576.3, y: 1597.3 },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.small,
    },
    {
      ...STANDS.placeholder,
      ...SIZES.small,
    },
  ]),
  // Leftmost expo cluster
  ...calculateColumn([
    {
      ...STANDS.placeholder,
      ...SIZES.longVertical,
      pos: { x: 376.3, y: 1394.3 },
    },
    ...calculateRow([
      {
        ...STANDS.placeholder,
        ...SIZES.longVertical,
        pos: { x: 376.3, y: 1394.3 - stringToSize("3") },
      },
      {
        ...STANDS.placeholder,
        ...SIZES.superlongVertical,
      },
    ]),
    {
      ...STANDS.placeholder,
      ...SIZES.medium,
      pos: { x: 376.3, y: 1394.3 - stringToSize("9") },
    },
  ]),
  // Center big stands expo cluster
  ...calculateColumn([
    {
      ...STANDS.placeholder,
      ...getStandSize("13x6"),
      pos: { x: 526.3, y: 1450.0 },
    },
    {
      ...STANDS.placeholder,
      ...getStandSize("6x12"),
    },
    ...calculateRow([
      {
        ...STANDS.placeholder,
        ...SIZES.small,
        pos: { x: 526.3, y: 1450.0 - stringToSize("15") },
      },
      {
        ...STANDS.placeholder,
        ...SIZES.small,
      },
      {
        ...STANDS.placeholder,
        ...getStandSize("7x15"),
      },
    ]),
  ]),
  // Rightmost expo cluster
  ...calculateColumn([
    ...calculateRow([
      {
        ...STANDS.placeholder,
        ...SIZES.long,
        pos: { x: 826.3, y: 1530.0 },
      },
      {
        ...STANDS.placeholder,
        ...SIZES.long,
      },
    ]),
    {
      ...STANDS.placeholder,
      ...SIZES.small,
      pos: { x: 826.3, y: 1530.0 - stringToSize("3") },
    },
    {
      ...STANDS.placeholder,
      ...SIZES.small,
    },
    ...calculateRow([
      {
        ...STANDS.placeholder,
        ...SIZES.longVertical,
        pos: { x: 826.3, y: 1530.0 - stringToSize("12") },
      },
      {
        ...STANDS.placeholder,
        ...getStandSize("9x12"),
      },
    ]),
    ...calculateRow([
      {
        ...STANDS.placeholder,
        ...SIZES.long,
        pos: { x: 826.3, y: 1530.0 - stringToSize("15") },
      },
      {
        ...STANDS.placeholder,
        ...SIZES.small,
      },
      {
        ...STANDS.placeholder,
        ...SIZES.small,
      },
    ]),
  ]),
  // Streamer cluster
  ...calculateRow([
    {
      ...ATTRACTIONS.streamerLounge,
      ...getStandSize("10x10"),
      pos: { x: 786.3, y: 1680.0 },
    },
  ]),
  ...calculateRow([
    {
      ...ATTRACTIONS.streamers,
      ...getStandSize("10x3"),
      pos: { x: 786.3, y: 1680.0 - stringToSize("3") },
    },
  ]),
  // TG Shop, lower left
  {
    ...STANDS.placeholder,
    ...getStandSize("12x20"),
    pos: { x: 694, y: 736 },
  },
  // Left stage (stage right) cluster
  ...calculateRow([
    {
      ...STANDS.placeholder,
      ...getStandSize("10x18"),
      pos: { x: 1056.3, y: 1420.0 },
    },
  ]),
  ...calculateRow([
    {
      ...STANDS.placeholder,
      ...getStandSize("10x6"),
      pos: { x: 1056.3, y: 1420.0 - stringToSize("6") },
    },
  ]),
  // Creativia cluster right of stage (stage left)
  ...calculateColumn([
    {
      ...STAGES.creativiaStage,
      ...getStandSize("9x12"),
      pos: { x: 2070, y: 1640 },
    },
    {
      ...STANDS.placeholder,
      ...getStandSize("9x6"),
    },
    {
      ...STANDS.placeholder,
      ...getStandSize("9x12"),
    },
  ]),
  // 2073, y: 1329
  // Testing: Rough stages
  {
    ...STAGES.mainStage,
    width: 280,
    height: 250,
    pos: { x: 1300, y: 1310 },
  },
  {
    ...STAGES.eSportStage,
    width: 280,
    height: 190,
    pos: { x: 1300, y: 1600 },
  },
].map((item, index) => ({
  ...item,
  slug: item.slug ?? `${slugifyMapItemName(item.name)}-${index}`,
}));

const usedLocations = LOCATIONS.flatMap(({ name, slug }) => [name, slug]);
const isUsed = ({ name, slug }: MapItemBase) =>
  usedLocations.includes(slug || "") || usedLocations.includes(name);
const nav = [
  {
    title: "Utstillere",
    items: Object.values(STANDS).filter(isUsed),
  },
  {
    title: "Mat",
    items: Object.values(FOOD).filter(isUsed),
  },
  {
    title: "Scener",
    items: Object.values(STAGES).filter(isUsed),
  },
].filter(({ items }) => items.length > 0);
---

<Layout title="The Gathering - Map" footerVariant="hidden">
  <meta name="robots" content="noindex" slot="head" />
  <TgMap locations={LOCATIONS}>
    <Fragment slot="nav">
      {
        nav.map(({ title, items }) => (
          <>
            <H3 class="mb-4">{title}</H3>
            <ul class="flex flex-row flex-wrap text-md font-bold text-white gap-2 mb-6">
              {items.map((item) => (
                <li>
                  <TgMapNavItem mapItem={item} />
                </li>
              ))}
            </ul>
          </>
        ))
      }
    </Fragment>
  </TgMap>
</Layout>
